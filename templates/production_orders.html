<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Список заказ-нарядов на производство</title>
        <style>
         .button {
             display: inline-block;
             padding: 10px 20px;
             background-color: #4CAF50;
             color: white;
             text-decoration: none;
             border-radius: 5px;
             transition: background-color 0.3s;
             margin-top: 20px;
         }
         .button:hover {
             background-color: #45a049;
         }
        </style>
    </head>
    <body>
        <!-- Добавляем отображение имени пользователя и ссылки на вход/выход -->
        <div style="position: absolute; top: 10px; right: 10px;">
            {% if current_user %}
            Вы вошли как: {{ current_user.username }} |
            <form action="/logout" method="post" style="display:inline;">
                <button type="submit" style="background:none;border:none;padding:0;margin:0;color:blue;text-decoration:underline;cursor:pointer;">Выйти</button>
            </form>
            {% else %}
            Вы вошли как: Гость | <a href="/login">Войти</a>
            {% endif %}
        </div>
        <h1>Список заказ-нарядов на производство</h1>

        <table id="ordersTable" border="1">
            <thead>
                <tr>
                    <th>Номер заказа</th>
                    <th>Дата публикации</th>
                    <th>Обозначение чертежа</th>
                    <th>Количество</th>
                    <th>Желательная дата изготовления</th>
                    <th>Необходимый материал</th>
                    <th>Срок поставки металла</th>
                    <th>Примечания</th>
                    <th>Действия</th>
                </tr>
            </thead>
            <tbody>
                {% if orders %}
                {% for order in orders %}
                <tr data-order-id="{{ order.id }}">
                    <td><a href="{{ url_for('edit_production_order', order_id=order.id) }}">{{ order.order_number }}</a></td>
                    <td>{% if order.publication_date %}{{ order.publication_date.strftime('%d.%m.%Y') }}{% endif %}</td>
                    <td><a href="{{ url_for('view_drawing', order_id=order.id) }}" target="_blank">{{ order.part.number }}</a></td>
                    <td>{{ order.quantity }}</td>
                    <td>{{ order.desired_production_date_start.strftime('%d.%m.%Y') }} - {{ order.desired_production_date_end.strftime('%d.%m.%Y') }}</td>
                    <td>{{ order.required_material }}</td>
                    <td>
                        {% if order.metal_delivery_date.__class__.__name__ == 'date' %}
                        {{ order.metal_delivery_date.strftime('%d.%m.%Y') }}
                        {% else %}
                        {{ order.metal_delivery_date }}
                        {% endif %}
                    </td>
                    <td>{% if order.notes %}{{ order.notes }}{% endif %}</td>
                    <td><a href="{{ url_for('print_order', order_id=order.id) }}" target="_blank">Печать заказа</a></td>
                </tr>
                {% endfor %}
                {% else %}
                <tr><td colspan="9">Нет доступных заказ-нарядов.</td></tr>
                {% endif %}
            </tbody>
        </table>

        <a href="{{ url_for('production_order_form') }}" class="button">Создать новый заказ</a>
        <a href="/" class="button">Вернуться на главную страницу</a>

        <script>
         let socket;
         let reconnectInterval = 5000; // 5 секунд между попытками переподключения
         let isConnected = false;

         function connectWebSocket() {
             if (isConnected) return;

             socket = new WebSocket("wss://" + window.location.host + "/ws");

             socket.onopen = function(e) {
                 console.log("[open] Соединение установлено");
                 isConnected = true;
                 reconnectInterval = 5000;
             };

             socket.onmessage = function(event) {
                 console.log(`[message] Данные получены с сервера: ${event.data}`);
                 if (event.data === 'ping') {
                     socket.send('pong');
                     return;
                 }
                 const data = JSON.parse(event.data);
                 if (data.action === "new_order" || data.action === "update_order") {
                     console.log("Обновление заказа:", data.order);
                     updateOrdersTable([data.order]);
                 }
             };

             socket.onclose = function(event) {
                 isConnected = false;
                 if (event.wasClean) {
                     console.log(`[close] Соединение закрыто чисто, код=${event.code} причина=${event.reason}`);
                 } else {
                     console.log('[close] Соединение прервано');
                 }
                 setTimeout(connectWebSocket, reconnectInterval);
                 reconnectInterval = Math.min(reconnectInterval * 1.5, 60000);
             };

             socket.onerror = function(error) {
                 console.log(`[error] ${error.message}`);
             };
         }

         function fetchOrders() {
             fetch('/api/orders')
                 .then(response => response.json())
                 .then(orders => {
                     console.log("Получены заказы:", orders);
                     updateOrdersTable(orders);
                 })
                 .catch(error => console.error('Ошибка при получении заказов:', error));
         }

         function updateOrdersTable(orders) {
             const tableBody = document.querySelector('#ordersTable tbody');
             orders.forEach(order => {
                 let row = tableBody.querySelector(`tr[data-order-id="${order.id}"]`);
                 if (!row) {
                     row = document.createElement('tr');
                     row.setAttribute('data-order-id', order.id);
                     tableBody.appendChild(row);
                 }
                 row.innerHTML = `
                     <td><a href="/edit_production_order/${order.id}">${order.order_number}</a></td>
                     <td>${order.publication_date}</td>
                     <td><a href="/view_drawing/${order.id}" target="_blank">${order.part.number}</a></td>
                     <td>${order.quantity}</td>
                     <td>${order.desired_production_date_start} - ${order.desired_production_date_end}</td>
                     <td>${order.required_material}</td>
                     <td>${order.metal_delivery_date}</td>
                     <td>${order.notes ? order.notes : ''}</td>
                     <td><a href="/print_order/${order.id}" target="_blank">Печать</a></td>
                 `;
             });
         }

         // Инициализация
         connectWebSocket();
         fetchOrders();

         // Периодическое обновление заказов
         setInterval(fetchOrders, 30000); // Обновляем каждые 30 секунд
        </script>
    </body>
</html>
