<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <title>Управление сессиями</title>
        <link rel="stylesheet" href="/static/styles.css">
        <style>
         .session-table {
             width: 100%;
             border-collapse: collapse;
             margin-top: 20px;
         }
         .session-table th, .session-table td {
             padding: 12px;
             border: 1px solid #ddd;
             text-align: left;
         }
         .session-table th {
             background-color: #f4f4f4;
         }
         .current-session {
             background-color: #e8f5e9;
         }
         .button-group {
             margin: 20px 0;
         }
         .terminate-btn {
             background-color: #f44336;
             color: white;
             border: none;
             padding: 8px 16px;
             cursor: pointer;
             border-radius: 4px;
         }
         .terminate-all-btn {
             background-color: #d32f2f;
             color: white;
             border: none;
             padding: 10px 20px;
             cursor: pointer;
             border-radius: 4px;
         }
        </style>
    </head>
    <body>
        <div class="container">
            <h1>Управление сессиями</h1>
            {% if is_temp_access %}
            <div class="alert alert-warning">
                Вы находитесь в режиме временного доступа. Для продолжения работы необходимо завершить неиспользуемые сессии.
            </div>
            {% endif %}
            <div class="button-group">
                <button onclick="terminateAllSessions()" class="terminate-all-btn">
                    Завершить все сессии
                </button>
            </div>
            <table class="session-table">
                <thead>
                    <tr>
                        <th>Устройство</th>
                        <th>IP-адрес</th>
                        <th>Последняя активность</th>
                        <th>Создана</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for session in sessions %}
                    <tr {% if session.is_current %}class="current-session"{% endif %}>
                        <td>{{ session.user_agent }}</td>
                        <td>{{ session.ip_address }}</td>
                        <td>{{ session.last_activity.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td>{{ session.created_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                        <td>
                            {% if session.is_expired %}
                            <span class="expired-badge">Истекла</span>
                            {% if session.cleanup_reason %}
                            <span class="reason-text">{{ session.cleanup_reason }}</span>
                            {% endif %}
                            {% else %}
                            <span class="active-badge">Активна</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if not session.is_expired and not session.is_current %}
                            <button onclick="terminateSession({{ session.id }})" class="terminate-btn">
                                Завершить
                            </button>
                            {% elif session.is_current %}
                            <span class="current-session-text">Текущая сессия</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>

            {% if active_sessions_count >= 5 %}
            <div class="warning-message">
                Достигнут лимит активных сессий ({{ active_sessions_count }}/5)
            </div>
            {% else %}
            <div class="info-message">
                Активных сессий: {{ active_sessions_count }}/5
            </div>
            {% endif %}

            <!-- Добавим кнопку для возврата к входу -->
            {% if is_temp_access %}
            <div class="action-buttons">
                <button onclick="window.location.href='/login'" class="back-btn">
                    Вернуться к входу
                </button>
            </div>
            {% endif %}
        </div>

        <script>
         async function terminateSession(sessionId) {
             if (!confirm('Вы уверены, что хотите завершить эту сессию?')) {
                 return;
             }

             // Получаем temp_token из URL если он есть
             const urlParams = new URLSearchParams(window.location.search);
             const tempToken = urlParams.get('temp_token');

             try {
                 const url = tempToken
                           ? `/sessions/${sessionId}/terminate?temp_token=${tempToken}`
                           : `/sessions/${sessionId}/terminate`;

                 const response = await fetch(url, {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json'
                     },
                     credentials: 'include'
                 });

                 if (response.ok) {
                     // Обновляем страницу с сохранением параметра temp_token
                     if (tempToken) {
                         window.location.href = `/sessions?temp_token=${tempToken}`;
                     } else {
                         window.location.reload();
                     }
                 } else {
                     const error = await response.json();
                     alert(`Ошибка: ${error.detail}`);
                 }
             } catch (error) {
                 alert('Произошла ошибка при завершении сессии');
                 console.error(error);
             }
         }

         async function terminateAllSessions() {
             if (!confirm('Вы уверены, что хотите завершить все сессии? Вам придется войти заново.')) {
                 return;
             }

             const urlParams = new URLSearchParams(window.location.search);
             const tempToken = urlParams.get('temp_token');

             try {
                 const url = tempToken
                           ? `/sessions/terminate-all?temp_token=${tempToken}`
                           : `/sessions/terminate-all`;

                 const response = await fetch(url, {
                     method: 'POST',
                     headers: {
                         'Content-Type': 'application/json'
                     },
                     credentials: 'include'
                 });

                 if (response.ok) {
                     window.location.href = '/login';
                 } else {
                     const error = await response.json();
                     alert(`Ошибка: ${error.detail}`);
                 }
             } catch (error) {
                 alert('Произошла ошибка при завершении сессий');
                 console.error(error);
             }
         }
         // Добавим функцию проверки токена
         async function checkTokenValidity() {
             const urlParams = new URLSearchParams(window.location.search);
             const tempToken = urlParams.get('temp_token');

             if (tempToken) {
                 try {
                     const response = await fetch('/validate-token', {
                         method: 'POST',
                         headers: {
                             'Content-Type': 'application/json'
                         },
                         body: JSON.stringify({ token: tempToken })
                     });

                     if (!response.ok) {
                         alert('Время действия временного доступа истекло. Вы будете перенаправлены на страницу входа.');
                         window.location.replace('/login');
                     }
                 } catch (error) {
                     console.error('Error validating token:', error);
                 }
             }
         }

         // Проверяем токен каждую минуту
         setInterval(checkTokenValidity, 60000);
        </script>
    </body>
</html>
