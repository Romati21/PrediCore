<!DOCTYPE html>
<html lang="ru">
    <head>
        <meta charset="UTF-8">
        <title>Управление пользователями</title>
        <link rel="stylesheet" href="/static/styles.css">
    </head>
    <body>
        <div class="container">
            <h1>Управление пользователями</h1>
            <table class="user-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Имя пользователя</th>
                        <th>Полное имя</th>
                        <th>Email</th>
                        <th>Роль</th>
                        <th>Действия</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.id }}</td>
                        <td>{{ user.username }}</td>
                        <td>{{ user.full_name }}</td>
                        <td>{{ user.email }}</td>
                        <td>
                            <select class="role-select" data-user-id="{{ user.id }}">
                                {% for role in ['Администратор', 'Мастер', 'Наладчик', 'Рабочий'] %}
                                <option value="{{ role }}" {% if user.role.value == role %}selected{% endif %}>
                                    {{ role }}
                                </option>
                                {% endfor %}
                            </select>
                        </td>
                        <td>
                            <button onclick="updateRole({{ user.id }})" class="update-btn">Обновить роль</button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <script>
         async function updateRole(userId) {
             const roleSelect = document.querySelector(`select[data-user-id="${userId}"]`);
             const newRole = roleSelect.value;

             try {
                 const response = await fetch(`/users/${userId}/role`, {
                     method: 'PUT',
                     headers: {
                         'Content-Type': 'application/json',
                         'Accept': 'application/json'
                     },
                     body: JSON.stringify({
                         role: newRole
                     }),
                     credentials: 'include'
                 });

                 if (response.ok) {
                     alert('Роль успешно обновлена');
                 } else {
                     const error = await response.json();
                     alert(`Ошибка: ${error.detail}`);
                 }
             } catch (error) {
                 alert('Произошла ошибка при обновлении роли');
                 console.error(error);
             }
         }
        </script>
    </body>
</html>
